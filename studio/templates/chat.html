{% extends "base.html" %}
{% block title %}{{ agent | capitalize }} Chat{% endblock %}

{% block content %}
<div id="mainContent" class="ml-64 transition-all duration-200">
  <!-- Chat Display Loop -->
  {% for entry in conversation %}
  <div class="bg-white dark:bg-gray-800 p-4 mb-4 rounded-lg shadow border-l-4 border-blue-500">
    <strong>You:</strong><br>{{ entry.user }}
  </div>
  <div class="bg-gray-100 dark:bg-gray-700 p-4 mb-4 rounded-lg shadow border-l-4 border-green-500">
    <strong>AI:</strong><br>{{ entry.ai }}
  </div>
  {% endfor %}
</div>

<!-- Chat Form -->
<form method="post" class="fixed bottom-0 left-64 right-0 bg-white dark:bg-gray-800 p-4 flex gap-3 border-t border-gray-200 dark:border-gray-700 z-50 transition-all duration-200" id="chatForm">
  {% if not conversation_name %}
  <input type="text" name="conversation_name" placeholder="Name this conversation..." required
         class="px-4 py-2 flex-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100" />
  {% else %}
  <input type="hidden" name="conversation_name" value="{{ conversation_name }}" />
  {% endif %}
  <textarea name="user_input" id="user_input" rows="2" placeholder="Send a message..." required
            class="px-4 py-2 flex-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 resize-none"></textarea>
  <button type="submit"
          class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">âž¤</button>
</form>
{% endblock %}

{% block script_extra %}
<script>
  window.onload = () => {
    if (localStorage.getItem("theme") === "dark") {
      document.documentElement.classList.add("dark");
    }

    const textarea = document.getElementById("user_input");
    if (textarea) {
      textarea.addEventListener("keydown", function (event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          this.form.submit();
        }
      });
    }

    // Sidebar Toggle Logic
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebarBtn');
    const mainContent = document.getElementById('mainContent');
    const chatForm = document.getElementById('chatForm');

    toggleBtn.addEventListener('click', () => {
      if (sidebar.classList.contains('translate-x-[-100%]')) {
        sidebar.classList.remove('translate-x-[-100%]');
        mainContent.classList.add('ml-64');
        chatForm.classList.add('left-64');
      } else {
        sidebar.classList.add('translate-x-[-100%]');
        mainContent.classList.remove('ml-64');
        chatForm.classList.remove('left-64');
      }
    });
  };
</script>
{% endblock %}
